var M={};!function(){M={version:"0.1.0"},M.STMatching=function(){this.EARTH_RADIUS=6378137,this.DEVIATION=20,this.OFFSET=.75},M.STMatching.prototype={pointToSegCross:function(a,b,c,d,e,f){var g=new M.Projection,h=g.ll2m(a,b),i=g.ll2m(c,d),j=g.ll2m(e,f),k=(j[1]-i[1])*(h[1]-i[1])+(j[0]-i[0])*(h[0]-i[0]);if(0>=k){var l=new M.Point(c,d);return l.originLongitude=a,l.originLatitude=b,l.isBreakpoint=!0,l}var m=(j[1]-i[1])*(j[1]-i[1])+(j[0]-i[0])*(j[0]-i[0]);if(k>=m){var l=new M.Point(e,f);return l.originLongitude=a,l.originLatitude=b,l.isBreakpoint=!0,l}var n=k/m,o=i[0]+(j[0]-i[0])*n,p=i[1]+(j[1]-i[1])*n,q=g.m2ll(o,p),l=new M.Point(q[0],q[1]);return l.originLongitude=a,l.originLatitude=b,l.isBreakpoint=!1,l},rad:function(a){return a*Math.PI/180},pointToPointDist:function(a,b,c,d){var e=this.rad(b),f=this.rad(d),g=e-f,h=this.rad(a)-this.rad(c),i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(g/2),2)+Math.cos(e)*Math.cos(f)*Math.pow(Math.sin(h/2),2)));return i*=this.EARTH_RADIUS,i=Math.round(1e4*i)/1e4},getCandidatePoints:function(a,b,c,d){console.log(d);for(var e=[],f=0;f<d.length;f++){for(var g=d[f],h=g.geometry.coordinates,i=0,j=0,k=h.length,l=0;k>l;l++){var m=this.pointToPointDist(a,b,h[l][0],h[l][1]);i=0===i?m:i,i>m&&(i=m,j=l)}if(0===j){var n=this.pointToSegCross(a,b,h[j][0],h[j][1],h[j+1][0],h[j+1][1]);e.push(n)}else if(j===k-1){var n=this.pointToSegCross(a,b,h[j][0],h[j][1],h[j-1][0],h[j-1][1]);e.push(n)}else{var o=this.pointToSegCross(a,b,h[j][0],h[j][1],h[j-1][0],h[j-1][1]),p=this.pointToSegCross(a,b,h[j][0],h[j][1],h[j+1][0],h[j+1][1]),q=this.pointToPointDist(o.longitude,o.latitude,o.originLongitude,o.originLatitude),r=this.pointToPointDist(p.longitude,p.latitude,p.originLongitude,p.originLatitude);e.push(r>q?o:p)}}e=this.observationProbability(a,b,e);var s=c?c:[];return s.push(e),s.length>1&&(s=this.transmissionProbability(s)),s},observationProbability:function(a,b,c){for(var d=0;d<c.length;d++){var e=c[d],f=this.pointToPointDist(a,b,e.longitude,e.latitude),g=1/(Math.pow(2*Math.PI,.5)*this.DEVIATION)*Math.pow(Math.E,-(f*f)/(2*this.DEVIATION*this.DEVIATION));e.probability=g}return c},transmissionProbability:function(a){for(var b=a[a.length-1],c=a[a.length-2],d=this.pointToPointDist(b[0].originLongitude,b[0].originLatitude,c[0].originLongitude,c[0].originLatitude),e=0;e<b.length;e++){for(var f=b[e],g=0,h=0;h<c.length;h++){var i=c[h],j=this.pointToPointDist(f.longitude,f.latitude,i.longitude,i.latitude),k=0;j>=this.OFFSET*d&&(k=d/j);var l=f.probability*k+i.probability;l>g&&(g=l,f.prePointId=i.id)}f.probability=g}return a},findRoute:function(a){for(var b=a[a.length-1],c=b[0],d=[],e=1;e<b.length;e++){var f=b[e];f.probability>c.probability&&(c=f)}d.unshift(c);for(var g=c.prePointId,e=a.length-2;e>=0;e--)for(var h=a[e],i=0;i<h.length;i++){var f=h[i];f.id===g&&(d.unshift(f),g=f.prePointId)}return d}}}(),function(){M.Point=function(a,b){this.id=M.Util.generateUUID(),this.longitude=a,this.latitude=b,this.originLongitude=null,this.originLatitude=null,this.probability=null,this.prePointId=null,this.nextPointId=null,this.isBreakpoint=!1},M.Point.prototype={pre:function(a){return a&&(this.prePoint=a),this.prePoint},next:function(a){return a&&(this.nextPoint=a),this.nextPoint},getProb:function(){return this.probability}}}(),function(){M.Projection=function(){this.r_major=6378137,this.r_minor=6356752.314245179,this.f=298.257223563},M.Projection.prototype={deg2rad:function(a){var b=a*(Math.PI/180);return b},rad2deg:function(a){var b=a/(Math.PI/180);return b},ll2m:function(a,b){var c=this.r_major*this.deg2rad(a);b>89.5&&(b=89.5),-89.5>b&&(b=-89.5);var d=this.r_minor/this.r_major,e=1-d*d,f=Math.sqrt(e),g=this.deg2rad(b),h=Math.sin(g),i=f*h,j=.5*f,k=Math.pow((1-i)/(1+i),j),l=Math.tan(.5*(.5*Math.PI-g))/k,m=0-this.r_major*Math.log(l),n=[c,m];return n},m2ll:function(a,b){var c=this.rad2deg(a/this.r_major),d=this.r_minor/this.r_major,e=Math.sqrt(1-d*d),f=this.rad2deg(this.pj_phi2(Math.exp(0-b/this.r_major),e)),g=[c,f];return g},pj_phi2:function(a,b){var c,d,e,f,g,h=15,i=Math.PI/2,j=1e-10,c=.5*b;d=i-2*Math.atan(a),g=h;do e=b*Math.sin(d),f=i-2*Math.atan(a*Math.pow((1-e)/(1+e),c))-d,d+=f;while(Math.abs(f)>j&&--g);return d}}}(),function(){M.Util={generateUUID:function(){for(var a="0123456789qwertyuioplkjhgfdsazxcvbnm",b="",c=40,d=0;c>d;d++)b+=a.charAt(Math.ceil(1e8*Math.random())%a.length);return b}}}();