var Db = require('mongodb').Db,
    MongoClient = require('mongodb').MongoClient,
    fs = require('fs'),
    Server = require('mongodb').Server,
    $ = require('jquery-node-browserify'),
    assert = require('assert');

var geodata = JSON.parse(fs.readFileSync('static/map.json', 'utf8'));

var db = new Db('geo_helsinki', new Server('localhost', 27017), {safe : true});
db.open(function(err, db) {
  var collection = db.collection("geodata");
  for(var i=0; i<geodata.features.length; i++) {
    if(geodata.features[i].geometry.type === 'LineString') {
      var feature = {};
      var coordinates = geodata.features[i].geometry.coordinates;
      coordinates = removeDuplicate(coordinates);
      feature.loc = geodata.features[i].geometry;
      feature.loc.coordinates = coordinates;
      collection.insert(feature, function(err, result) {
      });
    }
  }
  db.close();
});

function removeDuplicate(coordinates) {
  var polygons = [];
  for(var i=0; i<coordinates.length; i++) {
    var polygon = [];
    for(var j=0; j<coordinates[i].length; j++) {
      if(j==0) {
        polygon.push(coordinates[i][0]);
      }
      else if(coordinates[i][j][0] !== coordinates[i][0][0] || coordinates[i][j][1] !== coordinates[i][0][1]) {
        polygon.push(coordinates[i][j]);
      }
      else if(j==coordinates[i].length-1) {
        polygon.push(coordinates[i][j]);
      }
    }
    polygons.push(polygon);
  }
  return polygons;
}

//var coordinates = [ [ [ 24.943939, 60.169835 ], [ 24.9439443, 60.169786 ], [ 24.9440079, 60.169793 ], [ 24.9440055, 60.1698204 ], [ 24.9441094, 60.1698227 ], [ 24.9441949, 60.1698246 ], [ 24.9441973, 60.1697972 ], [ 24.9444499, 60.169802 ], [ 24.9444492, 60.169793 ], [ 24.944462, 60.1697827 ], [ 24.9444828, 60.16978 ], [ 24.9445002, 60.1697827 ], [ 24.9445123, 60.1697893 ], [ 24.9445136, 60.1698003 ], [ 24.9445277, 60.1698017 ], [ 24.9448187, 60.16981 ], [ 24.9448174, 60.1698247 ], [ 24.9448134, 60.1698577 ], [ 24.9448248, 60.169857 ], [ 24.9447738, 60.1702873 ], [ 24.9447215, 60.1702853 ], [ 24.9447228, 60.170279 ], [ 24.9446859, 60.1702776 ], [ 24.9446846, 60.1702863 ], [ 24.9446316, 60.170285 ], [ 24.9446323, 60.1702773 ], [ 24.9442628, 60.170267 ], [ 24.9442601, 60.1702836 ], [ 24.9441904, 60.1702826 ], [ 24.9441877, 60.1702993 ], [ 24.9441468, 60.1702987 ], [ 24.9441495, 60.170281 ], [ 24.9441409, 60.1702806 ], [ 24.9441415, 60.1702752 ], [ 24.9441513, 60.1702751 ], [ 24.944152, 60.1702716 ], [ 24.9441428, 60.1702714 ], [ 24.9441428, 60.1702694 ], [ 24.94414, 60.1702681 ], [ 24.9441405, 60.1702659 ], [ 24.9441445, 60.1702646 ], [ 24.9441482, 60.1702646 ], [ 24.9441488, 60.1702556 ], [ 24.9441428, 60.1702556 ], [ 24.9441435, 60.170252 ], [ 24.9441602, 60.170252 ], [ 24.9441609, 60.1702413 ], [ 24.9441757, 60.1702416 ], [ 24.9441804, 60.1702076 ], [ 24.9441643, 60.1702069 ], [ 24.9441643, 60.1702013 ], [ 24.9442213, 60.1702019 ], [ 24.9442213, 60.1701979 ], [ 24.9442239, 60.1701946 ], [ 24.94423, 60.1701936 ], [ 24.9442414, 60.1701929 ], [ 24.94424, 60.1702016 ], [ 24.9442769, 60.1702023 ], [ 24.9442769, 60.1702083 ], [ 24.9442682, 60.1702573 ], [ 24.944572, 60.170266 ], [ 24.9445793, 60.1702099 ], [ 24.9446471, 60.1702126 ], [ 24.9446504, 60.1701849 ], [ 24.944643, 60.1701843 ], [ 24.9446437, 60.1701799 ], [ 24.9446491, 60.1701799 ], [ 24.9446558, 60.1701125 ], [ 24.9447657, 60.1701155 ], [ 24.9447792, 60.1700151 ], [ 24.9446658, 60.1700118 ], [ 24.9446658, 60.1700071 ], [ 24.9447792, 60.1700101 ], [ 24.9447872, 60.1699364 ], [ 24.9446705, 60.1699331 ], [ 24.9446712, 60.1699257 ], [ 24.9447865, 60.1699284 ], [ 24.9447973, 60.1699247 ], [ 24.9447973, 60.1699144 ], [ 24.944806, 60.1699107 ], [ 24.9448093, 60.1698767 ], [ 24.944804, 60.169874 ], [ 24.9448046, 60.169864 ], [ 24.9447966, 60.1698584 ], [ 24.9446383, 60.1698537 ], [ 24.9446343, 60.1698814 ], [ 24.9446162, 60.1698811 ], [ 24.9446162, 60.169875 ], [ 24.9445465, 60.169873 ], [ 24.9445418, 60.1699154 ], [ 24.9445498, 60.1699214 ], [ 24.9446115, 60.1699227 ], [ 24.9446142, 60.1698951 ], [ 24.9446323, 60.1698957 ], [ 24.9446296, 60.1699224 ], [ 24.9446357, 60.1699221 ], [ 24.944631, 60.1699318 ], [ 24.9445726, 60.1699304 ], [ 24.9445632, 60.1700035 ], [ 24.9446176, 60.1700051 ], [ 24.9446169, 60.1700098 ], [ 24.9445934, 60.1701846 ], [ 24.944582, 60.1701843 ], [ 24.9445901, 60.1701272 ], [ 24.9442863, 60.1701195 ], [ 24.9442856, 60.1701252 ], [ 24.9442736, 60.1701249 ], [ 24.9442736, 60.1701195 ], [ 24.9442327, 60.1701182 ], [ 24.9442313, 60.1701302 ], [ 24.9442206, 60.1701302 ], [ 24.9442233, 60.1701175 ], [ 24.9442246, 60.1701069 ], [ 24.9442367, 60.1701069 ], [ 24.9442367, 60.1701105 ], [ 24.9442843, 60.1701112 ], [ 24.9442863, 60.1700932 ], [ 24.944228, 60.1700909 ], [ 24.9442286, 60.1700859 ], [ 24.9442226, 60.1700859 ], [ 24.944228, 60.1700455 ], [ 24.9442454, 60.1700458 ], [ 24.9442434, 60.1700695 ], [ 24.9443393, 60.1700715 ], [ 24.9443399, 60.1700508 ], [ 24.9443279, 60.1700502 ], [ 24.9443292, 60.1700358 ], [ 24.9443426, 60.1700358 ], [ 24.9443466, 60.1700021 ], [ 24.9443332, 60.1700018 ], [ 24.9443339, 60.1699875 ], [ 24.9442521, 60.1699851 ], [ 24.9442474, 60.1700258 ], [ 24.944232, 60.1700248 ], [ 24.9442327, 60.1700175 ], [ 24.9442125, 60.1700178 ], [ 24.9442159, 60.1699858 ], [ 24.944179, 60.1699855 ], [ 24.9441757, 60.1700098 ], [ 24.9441944, 60.1700105 ], [ 24.9441944, 60.1700175 ], [ 24.944181, 60.1700175 ], [ 24.9441783, 60.1700415 ], [ 24.9441777, 60.1700498 ], [ 24.9441616, 60.1700498 ], [ 24.9441663, 60.1699855 ], [ 24.9440556, 60.1699825 ], [ 24.9440489, 60.1700468 ], [ 24.9440281, 60.1700462 ], [ 24.9440281, 60.1700378 ], [ 24.9440335, 60.1700382 ], [ 24.9440369, 60.1700128 ], [ 24.9439839, 60.1700118 ], [ 24.9439765, 60.1700832 ], [ 24.9439591, 60.1700829 ], [ 24.9439705, 60.1699771 ], [ 24.9438907, 60.1699754 ], [ 24.9439025, 60.1698898 ], [ 24.9439051, 60.1698708 ], [ 24.9439054, 60.1698687 ], [ 24.9439329, 60.169869 ], [ 24.943939, 60.169835 ] ] ];
//console.log(removeDuplicate(coordinates));
